@using System.Web

@implements IDisposable

<CascadingValue Value="_RouteData">
    @ChildContent
</CascadingValue>

@code {
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Inject] private NavigationManager? NavigationManager { get; set; }

    private QueryRouteData _RouteData = new(view: "", parameter: "");

    public void Dispose()
    {
        if (this.NavigationManager is not null)
        {
            this.NavigationManager.LocationChanged -= this.NavigationManager_LocationChanged;
        }
    }

    protected override void OnInitialized()
    {
        if (this.NavigationManager is not null)
        {
            this.NavigationManager.LocationChanged += this.NavigationManager_LocationChanged;
            this.NavigationManager_LocationChanged(this, new LocationChangedEventArgs(this.NavigationManager.Uri, false));
        }
    }

    private void NavigationManager_LocationChanged(object? sender, LocationChangedEventArgs args)
    {
        var queryStrings = HttpUtility.ParseQueryString(new Uri(args.Location).Query);
        var viewMode = queryStrings["viewMode"] ?? "";
        var id = queryStrings["id"] ?? "";

        var newRouteData = new QueryRouteData(view: viewMode, parameter: id);

        if (this._RouteData != newRouteData)
        {
            this._RouteData = newRouteData;
            this.StateHasChanged();
        }
    }
}